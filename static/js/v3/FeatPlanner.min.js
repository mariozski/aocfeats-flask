define(["dojo/_base/array","dojo/query","dojo/dom-attr","dojo/dom","dojo/dom-style","dojo/dom-class","dojo/dom-geometry","dojo/dom-prop","dojo/window","dojo/html","dojo/on","dojo/request/xhr","dojo/dom-construct","dojo/mouse","dojo/io-query","dojo/NodeList-manipulate"],function(j,l,k,e,a,m,f,b,n,g,i,o,c,h,d){return function(X){var B=16,G=[14,9,10,9,12],V=false,x=[],C=X.classFeats().feats||{},Z=X.generalFeats||{},y=[],R="",E=["b-inactive","b-active","b-full"];var P=function(aa){return x[aa]};var Q=function(){var ab=0,aa;for(aa=0;aa<x.length;aa++){ab+=x[aa]}return ab};var O=function(){return 79-Q()};var F=function(){var aa=Q();l("#used-points").text(aa);l("#available-points").text(79-aa);l("#tree1").text(P(1));l("#tree2").text(P(2));l("#tree3").text(P(3))};var M=function(){u()};var u=function(){var aa=l("#link-id").text(),ab=[];j.forEach(y,function(ad,ac){if(ad.HasAnyPoints()){ab[ad.SortId()]=ad.Id()}});j.forEach(ab,function(ad,ac){if(typeof ad!="undefined"){aa+=ad}});if(!e.byId("view").checked){e.byId("view").checked=true}R="";l("#link-hidden").val(aa);i.emit(e.byId("link-hidden"),"change",{bubbles:true,cancelable:true});if(history!==undefined&&history.replaceState!==undefined){history.replaceState({},"",encodeURI(aa))}};var W=function(ab,aa){x[ab.tree]=x[ab.tree]+aa;F();M()};var S=function(aa){x[aa.tree]=x[aa.tree]-1;F();M()};var N=function(ab){var aa=null,ad={},ac={};if(ab.parent!=null){ad=ab.parent[0];ac=ab.parent[1];aa=j.filter(y,function(ae){return ae.tree==ab.tree&&ae.row==ad&&ae.column==ac})[0]}return aa};var z=function(ab){var aa=U(ab);return'<div class="border" style="width: 44px;height: 44px;left: '+(ab.row==1?27:0)+"px;top: -3px;background-image: url(/static/images/borders.png);background-position: "+(aa?(ab.IsFullyFitted()?"88px":"44px"):"0px")+' 0px;"></div><div class="feat" style="'+(ab.row==1?"left: 30px;":"")+"background-image: url("+(ab.tree==3?X.generalTree:X.classTree)+"); background-position: "+(-ab.imgIndex*ab.size).toString()+"px "+(ab.PointsNeeded()<=P(ab.tree)?ab.size:0)+'px;"></div>'};var A=function(ac){var ab="",aa=N(ac),ad=0,ae=0;if(ac.column==aa.column&&ac.row!=aa.row){ad=(ac.row-aa.row);ae=(ad>1?10:0);ab+='<div style="position: absolute; left: -4px; top: -'+((ad*38)+ae)+"px;background-image: url(/static/images/arrow_vertical.png); width: 48px; height: "+((ad*38)+ae+10)+'px; z-index: 0;"></div>'}else{if(ac.row==aa.row&&ac.column>aa.column){ab+='<div style="position: absolute; top: 0px;left: -20px; background-image: url(/static/images/arrow_right.png); height: 25px; width: 32px; z-index: 0;"></div>'}else{if(ac.row==aa.row&&ac.column<aa.column){ab+='<div style="position: absolute; top: 0px;left: 38px; background-image: url(/static/images/arrow_left.png); height: 37px; width: 32px; z-index: 0;"></div>'}}}return ab};var r=function(ac){var ab=0,aa=0;for(aa=0;aa<ac.availablePoints;aa++){ab+=G[aa]}return'<div class="points" style="width: '+ab.toString()+"px;left: "+(ac.row==1?22:(((4-ac.availablePoints)*4)+0))+"px;top: 40px;background-position: "+(U(ac)?"-54px ":"0px ")+ac.PositionY()+';">'};var q=function(aa){a.set(e.byId("feat-description"),"display","none")};var J=function(ai){var ak=ai.currentTarget||ai.fromTarget;if(typeof ak==="undefined"){return}var ac=ak.id,aj=parseInt(ac,10),ah=y[aj],ag=l("#feat-description"),ad=e.byId(aj.toString()),ab=f.position(ad),af=0,ae=n.getBox(),aa=ab.x+60+(ah.row==1?25:0),al=ab.y;ag.innerHTML(ah.GetDescription());ag.style("display","block");af=f.position(ag[0]);if((al+af.h)>ae.h){al=ae.h-af.h-10}if((aa+af.w)>ae.w){aa=aa-375}ag.style("top",al+"px");ag.style("left",aa+"px")};var U=function(aa){return(aa.PointsNeeded()<=P(aa.tree)&&(aa.parent==null||(aa.parent!=null&&N(aa).IsFullyFitted())))};var Y=function(ac){var ad=U(ac),ah=j.indexOf(y,ac).toString(),ag=ac.PositionX(),ae=(ad?ac.size:0)+"px",ab=(ad?(ac.IsFullyFitted()?"88px":"44px"):"0px")+" 0px",aa=l("#"+ah+" .border"),af=l("#"+ah+" .feat"),ai=af.style("backgroundPosition")[0].split(" ")[1];a.set(e.byId(ah).nextSibling,"backgroundPosition",(ad?"-54px ":"0px ")+ac.PositionY());if(aa.style("backgroundPosition")!==ab){aa.style("backgroundPosition",(ad?(ac.IsFullyFitted()?"88px":"44px"):"0px")+" 0px")}if(ae.trim()!==ai.trim()){l(".feat",e.byId(ah)).style("backgroundPosition",ag+" "+ae)}};var s=function(ab){var aa=j.indexOf(y,ab).toString();l(".feat",e.byId(aa)).style("backgroundPosition",(-ab.imgIndex*ab.size).toString()+"px "+(ab.HasAnyPoints()?ab.size:0)+"px");l(".border",e.byId(aa)).style("backgroundPosition",(ab.HasAnyPoints()?(ab.IsFullyFitted()?88:44):0)+"px 0px");a.set(e.byId(aa).nextSibling,"backgroundPosition",(ab.HasAnyPoints()?"-54px ":"0px ")+ab.PositionY())};var K=function(ac,ad){var aa=Q(),ad=typeof ad==="undefined"?"none":ad.click,ab=0;if((typeof ac==="undefined"&&aa!==79)||aa===78){for(ab=0;ab<y.length;ab++){Y(y[ab])}}else{if(typeof ac==="undefined"||aa===79){for(ab=0;ab<y.length;ab++){s(y[ab])}}else{for(ab=0;ab<y.length;ab++){if(ad==="none"){Y(y[ab])}else{if(ad!=="none"&&ac.tree===y[ab].tree&&ac.row<=y[ab].row){Y(y[ab])}}}}}};var I=function(ae){ae.preventDefault();var ad=ae.fromTarget||ae.currentTarget;if(typeof ad==="undefined"||V){return false}var aa=ae.ctrlKey,af=parseInt(ad.id,10),ac=y[af],ab=0;if((ac.PointsNeeded()>P(ac.tree))||(Q()>=79)||(ac.parent!=null&&!N(ac).IsFullyFitted())){return false}ab=ac.IncreaseUsedPoints(aa,O());if(ab>0){W(ac,ab);l("#feat-description").innerHTML(ac.GetDescription());v(ac);K(ac,{click:"left"})}return false};var v=function(ad,ae){var af=ad.Id(),ab=U(ad),aa=l("#"+af+" .border"),ac=0;ae=typeof ae!=="undefined"?ae:false;for(ac=0;ac<E.length;ac++){aa.removeClass(E[af])}if(ae){aa.addClass(ad.row==1?"b-inactive":"b-active")}else{aa.addClass(ab?(ad.IsFullyFitted()?"b-full":"b-active"):"b-inactive")}};var p=function(ak){ak.preventDefault();if(V){return}var am=ak.fromTarget||ak.currentTarget;if(am==undefined){return false}var ab=parseInt(am.id,10);var ai=y[ab];var an=[0,0,0,0,0,0,0,0,0,0];var al=true;var aj=0;var ae=true;var ah=0;var ad=0;var aa=true;j.forEach(y,function(ap,ao){if(ap.tree==ai.tree){if(ap.parent!=null&&ap.parent[0]==ai.row&&ap.parent[1]==ai.column){ae=!ap.HasAnyPoints()}if(ap.row>ai.row&&ap.HasAnyPoints()){al=false}else{if(ap.row<=ai.row&&ap.HasAnyPoints()){aj+=ap.Points()}}if(ap.HasAnyPoints()&&ap.PointsNeeded()>ah){ah=ap.PointsNeeded()}for(var ao=1;ao<=9;ao++){if(ap.row<=ao){an[ao]+=ap.Points()}}}});var ac=ah/5;for(var ag=ai.row;ag<=ac;ag++){var af=ag*5;if(an[ag]<=af){aa=false;break}}j.forEach(y,function(ap,ao){if(ap.tree==ai.tree&&ap.PointsNeeded()==ah){ad=ad+ap.Points()}});if(aa&&ae&&(al||(!al&&aj>(ai.PointsNeeded()+5)))&&(ai.PointsNeeded()==ah||ah<P(ai.tree)-ad)&&ai.DecreaseUsedPoints()){S(ai);l("#feat-description").innerHTML(y[ab].GetDescription());K(ai,{click:"right"})}return false};var T=function(aa){if(V){return}if(typeof aa=="undefined"){x=[0,0,0,0];j.forEach(y,function(ad,ab){ad.usedPoints=0;var ac=e.byId(ab.toString())})}else{x[aa]=0;j.forEach(y,function(ad,ab){if(ad.tree==aa){ad.usedPoints=0;var ac=e.byId(ab.toString())}})}F();K();M()};var L=function(ad){var aa=[];ad=ad.substring(3,ad.length);for(var ab=0;ad.length>0;ab++){var ae=ad.substring(0,5);var ac=parseInt(ae,16);aa[ab]=ac.toString();ad=ad.substring(5,ad.length)}return aa};var t=function(ag){if(ag==""){return true}if(ag.length<3){return false}var ac=["118","11c","112","127","114","11f","116","12c","129","11d","12b","122"],ah=ag.slice(0,3),ab=j.indexOf(ac,ah)!==-1;if(ab){var ae=ag.substring(3,ag.length);for(var ad=0;ae.length>0;ad++){var ai=ae.substring(0,5);if(ai.length!=5){return false}var aa=parseInt(ai,16);if(isNaN(aa)){return false}ae=ae.substring(5,ag.length)}}else{if(ag.length==y.length){for(var ad=0;ad<ag.length;ad++){var af=parseInt(ag[ad]);if(isNaN(af)){return false}if(!(af>=0&&af<=5)){return false}}}else{return false}}return true};var D=function(){ZeroClipboard.setMoviePath(X.zeroClipboardPath||alert("Could not load ZeroClipboard library!"));var aa=new ZeroClipboard.Client();aa.addEventListener("onMouseDown",function(ab){aa.setText(e.byId("link").value)});aa.glue("copykey");i(window,"resize",function(){aa.reposition()})};var H=function(){l("#link").on("click, focus",function(aa){aa.target.select()});l("#link").on("mouseup",function(aa){aa.preventDefault()})};var w=function(ab){if(X==undefined||X.classTree==undefined){return}var ae=X.classFeats();e.byId("tree1name").innerHTML=ae.treeNames[0];e.byId("tree2name").innerHTML=ae.treeNames[1];e.byId("link-id").innerHTML=ae.id;x=[0,0,0,0];y=C.concat(Z());var ad=l("#link-id").text();var aa=t(X.link);var ac=X.link.indexOf(ad)==0;j.forEach(y,function(aj,ah){var ai=l("div#feat-planner table").at(aj.tree-1).query("tr").at(aj.row).query("td").at(aj.column-1).query("div.fh")[0];if(ac){aj.usedPoints=0;if(aa){var ag=L(X.link);j.forEach(ag,function(ak){if(ak.indexOf(aj.RawId())==0){var al=parseInt(ak.substring(ak.length-1,ak.length))+1;aj.usedPoints=al;x[aj.tree]+=al}})}}else{aj.usedPoints=0;if(X.link!=""&&aa){var af=parseInt(X.link[ah],10);if(!isNaN(af)&&af>=0&&af<=5){aj.usedPoints=af;x[aj.tree]+=af}}}ai.id=ah;i(ai,h.enter,J);i(ai,h.leave,q);i(ai,"click",I);i(ai,"contextmenu",p);ai.innerHTML=z(aj);if(aj.parent!=null){c.place(A(aj),ai,"after")}c.place(r(aj),ai,"after")});if(!aa){e.byId("flash").innerHTML="*Provided build link is invalid* - "}l("#feat-planner-container").after('<div id="feat-description"></div>');D();H();i(e.byId("view"),"click",function(){var af=e.byId("view");if(!af.checked){if(R.length===0){e.byId("view").disabled=true;o.post(X.shorten,{data:{link:window.location},handleAs:"json"}).then(function(ag){R=ag.shorturl;e.byId("link").value=R},function(ag){i.emit(e.byId("link-hidden"),"change",{bubbles:true,cancelable:true})}).always(function(){e.byId("view").disabled=false})}else{e.byId("link").value=R}}else{i.emit(e.byId("link-hidden"),"change",{bubbles:true,cancelable:true})}});i(e.byId("load"),"click",function(){var af=l("#link").val();if(af!==""&&t(af)){document.location.href=l("#import-base").text()+af}});i(e.byId("link-hidden"),"change",function(){e.byId("link").value=this.value});i(e.byId("clear-button"),"click",function(){T()});l("#clear-tree1, #clear-tree2, #clear-tree3").on("click",function(af){if(af.target.id=="clear-tree1"){T(1)}else{if(af.target.id=="clear-tree2"){T(2)}else{if(af.target.id=="clear-tree3"){T(3)}}}});F();K();M()};return function(aa){w(aa)}}});